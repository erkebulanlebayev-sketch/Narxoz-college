# Настройка восстановления пароля

## Обзор
Система восстановления пароля позволяет пользователям сбросить забытый пароль через email.

## Возможности
- ✅ Запрос на восстановление пароля по email
- ✅ Безопасная ссылка для сброса пароля
- ✅ Валидация нового пароля
- ✅ Автоматическое перенаправление после успешного сброса

## Настройка в Supabase

### 1. Настройка Email Templates

1. Откройте [Supabase Dashboard](https://app.supabase.com)
2. Выберите ваш проект
3. Перейдите в **Authentication** → **Email Templates**
4. Найдите шаблон **Reset Password**
5. Убедитесь, что URL для сброса указывает на ваш домен:

```
{{ .SiteURL }}/reset-password?token={{ .Token }}&type=recovery
```

### 2. Настройка Site URL

1. Перейдите в **Authentication** → **URL Configuration**
2. Установите **Site URL**:
   - Для разработки: `http://localhost:4001`
   - Для продакшена: `https://ваш-домен.vercel.app`
3. Добавьте **Redirect URLs**:
   - `http://localhost:4001/reset-password`
   - `https://ваш-домен.vercel.app/reset-password`

### 3. Настройка Email Provider (опционально)

По умолчанию Supabase использует встроенный email сервис (ограничение: 3 письма в час).

Для продакшена рекомендуется настроить свой SMTP:

1. Перейдите в **Project Settings** → **Auth**
2. Прокрутите до **SMTP Settings**
3. Включите **Enable Custom SMTP**
4. Заполните данные вашего SMTP провайдера (Gmail, SendGrid, Mailgun и т.д.)

## Использование

### Восстановление пароля

1. Пользователь нажимает **"Забыли пароль?"** на странице входа
2. Вводит свой email
3. Получает письмо со ссылкой для сброса
4. Переходит по ссылке
5. Вводит новый пароль (минимум 6 символов)
6. Автоматически перенаправляется на страницу входа

### Страницы

- `/login` - Страница входа с ссылкой "Забыли пароль?"
- `/forgot-password` - Форма запроса восстановления пароля
- `/reset-password` - Форма установки нового пароля

## Безопасность

- Ссылка для сброса действительна ограниченное время (по умолчанию 1 час)
- Ссылка одноразовая - после использования становится недействительной
- Пароль должен содержать минимум 6 символов
- Проверка совпадения пароля и подтверждения

## Тестирование

### Локальная разработка

1. Запустите dev сервер: `npm run dev`
2. Откройте `http://localhost:4001/login`
3. Нажмите "Забыли пароль?"
4. Введите email тестового аккаунта
5. Проверьте письмо в Supabase Dashboard → Authentication → Logs
6. Скопируйте ссылку из логов и откройте в браузере

### Продакшен

1. Убедитесь, что Site URL настроен правильно
2. Убедитесь, что SMTP настроен (для отправки реальных писем)
3. Протестируйте полный flow восстановления пароля

## Устранение проблем

### Письмо не приходит

- Проверьте папку "Спам"
- Проверьте SMTP настройки в Supabase
- Проверьте лимиты отправки (3 письма/час для встроенного сервиса)
- Проверьте логи в Supabase Dashboard → Authentication → Logs

### Ссылка не работает

- Проверьте Site URL в настройках Supabase
- Проверьте Redirect URLs
- Убедитесь, что ссылка не истекла (действительна 1 час)
- Проверьте, что ссылка не была использована ранее

### Ошибка "Invalid session"

- Ссылка истекла или уже использована
- Запросите новую ссылку через `/forgot-password`

## Кастомизация

### Изменение времени действия ссылки

В Supabase Dashboard → Authentication → Settings:
- **JWT expiry limit** - время жизни токена

### Изменение шаблона письма

В Supabase Dashboard → Authentication → Email Templates:
- Отредактируйте HTML шаблон письма
- Добавьте свой брендинг и стили

### Изменение минимальной длины пароля

В `app/reset-password/page.tsx`:
```typescript
if (password.length < 6) {
  setError('Пароль должен содержать минимум 6 символов');
  // Измените 6 на нужное значение
}
```

## Дополнительные улучшения

- [ ] Индикатор силы пароля
- [ ] Требования к паролю (заглавные буквы, цифры, спецсимволы)
- [ ] История паролей (запрет повторного использования)
- [ ] Двухфакторная аутентификация
- [ ] Уведомление на email при смене пароля
